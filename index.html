<html>
<head>
    <title>Genealogy</title>
    <script src='https://d3js.org/d3.v4.min.js'></script>
<style>

.node circle {
  fill: #fff;
  stroke: red;
  stroke-width: 3px;
}

.node text {
  font: 12px "Futura";
}

.link {
  fill: none;
  stroke: red;
  stroke-width: 2px;
  opacity: 0.5;
}

.name {
  font-size: 8px
}

.university {
  font-size: 4px 
}

.tag text{
    font-size: 42px;
    opacity: 0.5;
    fill: red;
    font-family: "Futura";
}

</style>
</head>
<body>
<svg width="100vw" height="100vh"></svg>
<script>

    var margin = {top: 20, right: 90, bottom: 30, left: 90};
    

    var svgContainer = d3.select("svg");
        

    var svg = svgContainer.append("g")
        .attr("transform", "translate(" + 0 + "," + 0 + ")");





    var width = 3000,
        height = 2000;


    var treemap = d3.tree().size([height, width]);
    
    var i = 0,
        duration = 750,
        root;


    function clean(root) {
        if(root.children) {
            root.children = root.children.filter(function(child) {
                return !isNaN(parseInt(child.year));
            })
            root.children.forEach(clean);
        }
    }

    function vh(v) {
        var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
        
        return (v * h) / 100;
    }

    function vw(v) {
        var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
        
        return (v * w) / 100;
    }


    d3.json("genealogy.json", function(error, data) {
        console.log(data);

        clean(data)

        root = d3.hierarchy(data, function(d) { return d.children; });
        root.x0 = height / 2;
        root.y0 = 0;

        //root.children.forEach(collapse);

        update(root);
    });

    // Collapse the node and all it's children
    function collapse(d) {
      if(d.children) {
        d._children = d.children
        d._children.forEach(collapse)
        d.children = null
      }
    }

    function myRange(start, edge, step) {
        // If only 1 number passed make it the edge and 0 the start
        if (arguments.length === 1) {
            edge = start;
            start = 0;
        }
      
        // Validate edge/start
        edge = edge || 0;
        step = step || 1;
      
        // Create array of numbers, stopping before the edge
        let arr = [];
        for (arr; (edge - start) * step > 0; start += step) {
            arr.push(start);
        }
        return arr;
    }

    function update(source) {
        var treeData = treemap(root);

        // Compute the new tree layout.
        var nodes = treeData.descendants(),
            links = treeData.descendants().slice(1);
        // Normalize for fixed-depth.

        var years = nodes.map(function(d){ return parseInt(d.data.year) });


        var min = Math.min(...years);
        var max = Math.max(...years);





        
        


        var range = max - min;

        var step = range / treeData.height;

        var x = d3.scaleLinear()
                  .domain([min, max])
                  .range([0, height]);
        nodes.forEach(function(d){ d.y = x(parseInt(d.data.year));
                                   d.x = d.x + 100; });





        var tags = myRange(min, max, 100);

        console.log(tags);
        

        svg.selectAll('g')
            .data(tags)
            .enter()
            .append('g')
            .attr('class', 'tag')
            .attr("transform", function(d) {
                return "translate(0," + x(d) + ")";
            })
            .append('text')
            .text(function(d) {
                return  d});


        // Update the nodes...
        var node = svg.selectAll('g.node')
            .data(nodes, function(d) { return d.id });

        var nodeEnter = node.enter().append('g')
            .attr('class', 'node')
            .attr("transform", function(d) {
                return "translate(" + source.y0 + "," + source.x0 + ")";
            });


        var container = nodeEnter.append("a")
            .attr("xlink:href", function(d){ return "https://www.genealogy.math.ndsu.nodak.edu/id.php?id=" + d.data.gen_id });


        // Add Circle for the nodes
        container.append('circle')
            .attr('class', 'node')
            .attr('r', 10)
            .style("fill", function(d) {
                return d._children ? "red" : "#fff";
        })
        .on('click', click);


              // Add labels for the nodes
        var text = container.append('text')
            .attr("x", function(d) {
                return  0;
            })
            .attr("text-anchor", function(d) {
                return "start";
            })


        text.append('tspan')
            .attr('class', 'name')
            .text(function(d) { return d.data.name })
            .attr('x', 0);
            ;

        text.append('tspan')
            .attr('class', 'university')
            .text(function(d) { return d.data.university })
            .attr('dy', '1em')
            .attr('x', 0);

          // UPDATE
        var nodeUpdate = nodeEnter.merge(node);

        // Transition to the proper position for the node
        nodeUpdate.transition()
            .duration(duration)
            .attr("transform", function(d) { 
                return "translate(" + d.x + "," + d.y + ")";
            });
        // Update the node attributes and style
        nodeUpdate.select('circle.node')
            .attr('r', 1e-6)
            .style("fill", function(d) {
                return d._children ? "lightsteelblue" : "#fff";
            })
            .attr('cursor', 'pointer');


        // Remove any exiting nodes
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function(d) {
                return "translate(" + source.y + "," + source.x + ")";
            })
            .remove();

        // On exit reduce the node circles size to 0
        nodeExit.select('circle')
            .attr('r', 1e-6);

        // On exit reduce the opacity of text labels
        nodeExit.select('text')
            .style('fill-opacity', 1e-6);
   
        
          // ****************** links section ***************************

        // Update the links...
        var link = svg.selectAll('path.link')
            .data(links, function(d) { return d.id; });

        // Enter any new links at the parent's previous position.
        var linkEnter = link.enter().insert('path', "g")
            .attr("class", "link")
            .attr('d', function(d){
                var o = {x: source.y0, y: source.x0}
                return diagonal(o, o)
            });

        // UPDATE
        var linkUpdate = linkEnter.merge(link);

        // Transition back to the parent element position
        linkUpdate.transition()
            .duration(duration)
            .attr('d', function(d){ return diagonal(d, d.parent) });

        // Remove any exiting links
        var linkExit = link.exit().transition()
            .duration(duration)
            .attr('d', function(d) {
                var o = {x: source.y, y: source.x}
                return diagonal(o, o)
            })
            .remove();

        // Store the old positions for transition.
        nodes.forEach(function(d){
            d.x0 = d.y;
            d.y0 = d.x;
        });

        // Creates a curved (diagonal) path from parent to the child nodes
        function diagonal(s, d) {
            path = `M ${s.x} ${s.y}
                    C ${(s.x + d.x) / 2} ${d.y},
                      ${(s.x + d.x) / 2} ${s.y},
                      ${d.x} ${d.y}`
            return path
        }

        // Toggle children on click.
        function click(d) {
          if (d.children) {
              d._children = d.children;
              d.children = null;
            } else {
              d.children = d._children;
              d._children = null;
            }
          update(d);
        }


    }
    
    svgContainer
    .call(d3.zoom()
        .scaleExtent([1, 8])
        .on("zoom", zoom));

    function zoom() {
        svg.attr("transform", d3.event.transform);
    }


</script>
</body>
</html>