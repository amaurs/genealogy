<html>
<head>
    <title>Genealogy</title>
    <script src='https://d3js.org/d3.v4.min.js'></script>
    <script src='https://dagrejs.github.io/project/graphlib/latest/graphlib.js'></script>
    <script src='https://dagrejs.github.io/project/dagre/latest/dagre.js'></script>
    <script src="https://dagrejs.github.io/project/dagre-d3/latest/dagre-d3.js"></script>
<style>

.node circle {
  fill: #fff;
  stroke: red;
  stroke-width: 3px;
}

.node text {
  font: 12px "Futura";
}

.link {
  fill: none;
  stroke: red;
  stroke-width: 2px;
  opacity: 0.5;
}

.name {
  font-size: 8px
}

.university {
  font-size: 4px 
}

.tag text{
    font-size: 42px;
    opacity: 0.5;
    fill: red;
    font-family: "Futura";
}
body {    
    margin: 0;
    padding: 0;
}
svg {
  border-style: solid;
  border-color: green;
}


text {
  font-weight: 300;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 14px;
}

.node rect {
  stroke: #999;
  fill: #fff;
  stroke-width: 1.5px;
}

.edgePath path {
  stroke: #333;
  stroke-width: 1.5px;
}


.svg-container {
}

.svg-content { 
    text-align: center;
}

</style>
</head>
<body class="svg-container">
<script>
    var width = vw(100),
        height = vh(100),
        centerX = 0 + width / 2,
        centerY = 0 + height / 2;
    var margin = {top: 20, right: 90, bottom: 30, left: 90};
    
    var svgContainer = d3.select("body")
            .append("svg")
            .attr("class", "svg-content")
            .attr('viewBox', "0 0 " + 2500 + " " + 2500 + "")
            .attr('preserveAspectRatio', "xMidYMid slice");

    var svg = svgContainer.append("g")
        .attr("transform", "translate(" + 0 + "," + 0 + ")");

    function vh(v) {
        var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
        
        return (v * h) / 100;
    }

    function vw(v) {
        var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
        
        return (v * w) / 100;
    }




    svgContainer
    .call(d3.zoom()
        .scaleExtent([1, 8])
        .on("zoom", zoom));

    function zoom() {
        var event = d3.event;
        console.log(event.transform)
        svg.attr("transform", d3.event.transform);
    }

    var treemap = d3.tree().size([height, width]);
    
    var i = 0,
        duration = 750,
        root;

    var nodez;

    var links;


    d3.json("nodes.json", function(error, nodes) {
        d3.json("edges.json", function(error, edges) {

            var g = new dagre.graphlib.Graph();
            g.setGraph({});
            g.setDefaultEdgeLabel(function() { return {}; });
            var entries = Object.entries(nodes);
            entries = entries.filter(function(entry){
                var value = entry[1];
                return !(value.year == "" || value.name == "" || value.school == "");
            });
            entries.forEach(function([key, value]){
                if(value){
                    g.setNode(key, value);
                }
            });
            edges.forEach(function(edge){                
                if(g.hasNode(edge.target) && g.hasNode(edge.source)){
                    g.setEdge(edge.target, edge.source);
                }
            })
            dagre.layout(g);

            console.log(graphlib.json.write(g));
            console.log(g);
            var xs = g.nodes().map(function(node) {
                var label = g.node(node);
                return label.x;
            });

            var ys = g.nodes().map(function(node) {
                var label = g.node(node);
                return label.y;
            });

            console.log(Math.min(...xs));
            console.log(Math.min(...ys));

            console.log(Math.max(...xs));
            console.log(Math.max(...ys));


            nodez = g.nodes().map(function(node) {
                var label = g.node(node);

                label.id = node;
                return label;
            });

            

            var maxX = Math.max(...xs);
            var maxY = Math.max(...ys);


            var years = nodez.map(function(d){ return parseInt(d.year) })
                       .filter(function(year) { return Number.isInteger(year) });

            var min = Math.min(...years);
            var max = Math.max(...years);

            var xs = g.nodes().map(function(node) {
                var label = g.node(node);
                return label.x;
            });
            maxX = Math.max(...xs);

            var y = d3.scaleLinear()
                  .domain([min, max])
                  .range([0, height]);

            nodez.forEach(function(d){  d.y = y(d.year); console.log(d.y + " " + d.year) });

            links = g.edges().map(function(edge) {
                var v = edge.v;
                var w = edge.w;

                var link = {};

                var source = g.node(v);
                var target = g.node(w);

                link.source = {x:source.x, y:source.y};
                link.target = {x:target.x, y:target.y};

                link.sourceId = v;
                link.targetId = w;

                return link;
            });


            renderD3(maxX, maxY, nodez, links)
        });
    });

    function renderD3(maxX, maxY, nodes, links){



        var y = d3.scaleLinear()
                  .domain([0, maxX])
                  .range([0, 1000]);

        var x = d3.scaleLinear()
                  .domain([0, maxY])
                  .range([0, 2500]);

        var node = svg.selectAll('g.node')
            .data(nodes, function(d) { return d.id });

            console.log(node);



        var nodeEnter = node.enter().append('g')
            .attr('class', 'node')
            .attr('id', function(d) { return d.id} )
            .attr("transform", function(d) {
                return "translate(" + x(+d.x) + "," + y(+d.y) + ")";
            });

        nodeEnter.call(d3.drag().on("drag", dragged));

        function dragged(d) {
            d.x = d3.event.x, d.y = d3.event.y;
            

            console.log(this);
            console.log("translate(" + x(+d.x) + "," + y(+d.y) + ")");


            var transform = d3.select(this).attr("transform");


            var id = d3.select(this).attr("id");

            transform = transform.replace("translate(", "");

            d3.select(this).attr("transform", function(d) {
                return "translate(" + x(+d.x) + "," + transform.split(",")[1];
            })

            links.forEach(function(link){
                if(link.sourceId == id){
                    link.source.x = +d.x;
                }
                if(link.targetId == id){
                    link.target.x = +d.x;
                }
            });

            var link = svg.selectAll('path.link')
                .data(links);


            link.transition()
                .duration(0)
                .attr('d', function(d){
                    return diagonal(d.source, d.target) });


        }

        var container = nodeEnter.append("a")
            .attr("xlink:href", function(d){ return "https://www.genealogy.math.ndsu.nodak.edu/id.php?id=" + d.id });



        var text = container.append('text')
            .attr("x", function(d) {
                return  0;
            })
            .attr("text-anchor", function(d) {
                return "start";
            }); 

        text.append('tspan')
            .attr('class', 'name')
            .text(function(d) { return d.name + " " + d.year})
            .attr('x', 0);
            ;

        text.append('tspan')
            .attr('class', 'university')
            .text(function(d) { return d.school })
            .attr('dy', '1em')
            .attr('x', 0);


        var link = svg.selectAll('path.link')
            .data(links);

        var linkEnter = link.enter().insert('path', "g")
            .attr("class", "link")
            .attr('d', function(d){
                return diagonal(d.source, d.target)
            });

        function diagonal(s, d) {
            path = `M ${x(s.x)} ${y(s.y)}
                    C ${(x(s.x) + x(d.x)) / 2} ${y(d.y)},
                      ${(x(s.x) + x(d.x)) / 2} ${y(s.y)},
                      ${x(d.x)} ${y(d.y)}`
            return path
        }

    }


</script>
</body>
</html>